window.germanized=window.germanized||{},window.germanized.dhl_parcel_finder=window.germanized.dhl_parcel_finder||{},function(t,s){s.dhl_parcel_finder={params:{},parcelShops:[],wrapper:"",init:function(){var e=s.dhl_parcel_finder;e.params=wc_gzd_dhl_parcel_finder_params,e.wrapper=e.params.wrapper,t(document).on("click",".gzd-dhl-parcel-shop-modal",e.openModal).on("click","#dhl-parcel-finder-wrapper .dhl-parcel-finder-close",e.closeModal).on("submit","#dhl-parcel-finder-wrapper #dhl-parcel-finder-form",e.onSubmit).on("click","#dhl-parcel-finder-wrapper .dhl-retry-search",e.onSubmit).on("click","#dhl-parcel-finder-wrapper .dhl-parcelshop-select-btn",e.onSelectShop),t(document.body).on("woocommerce_gzd_dhl_location_available_pickup_types_changed",e.onChangeAvailablePickupTypes)},onChangeAvailablePickupTypes:function(){var e=s.dhl_parcel_finder,a=s.dhl_parcel_locator,p=e.getModal(),e=a.getShippingMethod(),a=a.getShippingMethodData(e);a&&(p.find(".finder-pickup-type").addClass("hidden"),t.each(a.supports,function(e,a){a=p.find('.finder-pickup-type[data-pickup_type="'+a+'"]');a.find("input[type=checkbox]").prop("checked",!0),a.removeClass("hidden")}))},openModal:function(){var e=s.dhl_parcel_finder,a=e.getModal(),p=(0<t(e.wrapper+" #shipping_country").val().length?t(e.wrapper+" #shipping_country"):t(e.wrapper+" #billing_country")).val();a.find("#dhl-parcelfinder-country").val(p);p=(0<t(e.wrapper+" #shipping_postcode").val().length?t(e.wrapper+" #shipping_postcode"):t(e.wrapper+" #billing_postcode")).val();a.find("#dhl-parcelfinder-postcode").val(p);e=(0<t(e.wrapper+" #shipping_city").val().length?t(e.wrapper+" #shipping_city"):t(e.wrapper+" #billing_city")).val();return a.find("#dhl-parcelfinder-city").val(e),a.addClass("open"),a.find("#dhl-parcel-finder-form").submit(),!1},closeModal:function(){return s.dhl_parcel_finder.getModal().removeClass("open"),!1},getModal:function(){return t("#dhl-parcel-finder-wrapper")},doAjax:function(e,p,a,r){var n=s.dhl_parcel_finder;a=a||n.onAjaxSuccess,r=r||n.onAjaxError,e.hasOwnProperty("security")||(e.security=n.params.parcel_finder_nonce),p.find("#dhl-parcel-finder-map").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),p.find(".notice-wrapper").empty(),t.ajax({type:"POST",url:n.params.ajax_url,data:e,success:function(e){e.success?(p.find("#dhl-parcel-finder-map").unblock(),a.apply(p,[e])):(r.apply(p,[e]),p.find("#dhl-parcel-finder-map").unblock(),e.hasOwnProperty("message")?n.addNotice(e.message,"error",p):e.hasOwnProperty("messages")&&t.each(e.messages,function(e,a){n.addNotice(a,"error",p)}))},error:function(e){},dataType:"json"})},onAjaxSuccess:function(e){},onAjaxError:function(e){},getFormData:function(e){var p={};return t.each(e.serializeArray(),function(e,a){-1!==a.name.indexOf("[]")?(a.name=a.name.replace("[]",""),p[a.name]=t.makeArray(p[a.name]),p[a.name].push(a.value)):p[a.name]=a.value}),p},onSubmit:function(e){var a=s.dhl_parcel_finder,p=s.dhl_parcel_locator,r=a.getModal().find("#dhl-parcel-finder"),n=r.find("form"),n=a.getFormData(n);return n.action="woocommerce_gzd_dhl_parcelfinder_search",n.is_checkout=p.isCheckout()?"yes":"no",a.doAjax(n,r,a.onSubmitSuccess),!1},onSubmitSuccess:function(e){var a=s.dhl_parcel_finder;e.parcel_shops&&(a.parcelShops=e.parcel_shops,"object"==typeof google&&"object"==typeof google.maps?a.updateMap():a.loadMapsAPI())},loadMapsAPI:function(){var e=s.dhl_parcel_finder;e.addScript("https://maps.googleapis.com/maps/api/js?key="+e.params.api_key,e.updateMap)},addScript:function(e,a){var p=document.createElement("script");a&&(p.onload=a),p.type="text/javascript",p.src=e,document.body.appendChild(p)},updateMap:function(){var l=s.dhl_parcel_finder,e=l.parcelShops,a={lat:e[0].place.geo.latitude,lng:e[0].place.geo.longitude},c=new google.maps.Map(document.getElementById("dhl-parcel-finder-map"),{zoom:13,center:a}),d=[];t.each(e,function(e,a){var p={lat:a.place.geo.latitude,lng:a.place.geo.longitude},r=l.params.packstation_icon,n=l.params.i18n.packstation;switch(a.gzd_type){case"parcelshop":r=l.params.parcelshop_icon,n=l.params.i18n.branch;break;case"postoffice":r=l.params.postoffice_icon,n=l.params.i18n.branch}var i=new google.maps.InfoWindow({content:a.html_content,maxWidth:300});d.push(i);var o=new google.maps.Marker({position:p,map:c,title:n,animation:google.maps.Animation.DROP,icon:r});o.addListener("click",function(){!function(){for(var e=0;e<d.length;e++)d[e].close()}(),i.open(c,o)})})},onSelectShop:function(){var r=s.dhl_parcel_finder,n=t(this).attr("id"),i=t(r.wrapper+" #shipping_address_type"),o=t(r.wrapper+" #shipping_country").val(),l=s.dhl_parcel_locator.getPickupFieldKey(o);t.each(r.parcelShops,function(e,a){if(a.gzd_result_id===n){var p="packstation"===a.gzd_type;return t(r.wrapper+" #shipping_first_name").val((0<t(r.wrapper+" #shipping_first_name").val().length?t(r.wrapper+" #shipping_first_name"):t(r.wrapper+" #billing_first_name")).val()),t(r.wrapper+" #shipping_last_name").val((0<t(r.wrapper+" #shipping_last_name").val().length?t(r.wrapper+" #shipping_last_name"):t(r.wrapper+" #billing_last_name")).val()),t(r.wrapper+" #shipping_"+l).val(a.gzd_name),"DE"===o?t(r.wrapper+" #shipping_address_2").val(""):t(r.wrapper+" #shipping_address_1").val(a.place.address.streetAddress),t(r.wrapper+" #shipping_postcode").val(a.place.address.postalCode),t(r.wrapper+" #shipping_city").val(a.place.address.addressLocality),i.val("dhl").trigger("change"),r.closeModal(),"DE"===o&&p&&""===t(r.wrapper+" #shipping_dhl_postnumber").val()&&t(r.wrapper+" #shipping_dhl_postnumber").focus(),!0}})},addNotice:function(e,a,p){p.find(".notice-wrapper").append('<div class="notice notice-'+a+'"><p>'+e+"</p></div>")}},t(document).ready(function(){s.dhl_parcel_finder.init()})}(jQuery,window.germanized);