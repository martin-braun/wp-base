window.germanized=window.germanized||{},window.germanized.dhl_parcel_finder=window.germanized.dhl_parcel_finder||{},function(o,t){t.dhl_parcel_finder={params:{},parcelShops:[],wrapper:"",init:function(){var e=t.dhl_parcel_finder;e.params=wc_gzd_dhl_parcel_finder_params,e.wrapper=e.params.wrapper,o(document).on("click",".gzd-dhl-parcel-shop-modal",e.openModal).on("click","#dhl-parcel-finder-wrapper .dhl-parcel-finder-close",e.closeModal).on("submit","#dhl-parcel-finder-wrapper #dhl-parcel-finder-form",e.onSubmit).on("click","#dhl-parcel-finder-wrapper .dhl-retry-search",e.onSubmit).on("click","#dhl-parcel-finder-wrapper .dhl-parcelshop-select-btn",e.onSelectShop),o(document.body).bind("woocommerce_gzd_dhl_location_available_pickup_types_changed",e.onChangeAvailablePickupTypes)},onChangeAvailablePickupTypes:function(){var e=t.dhl_parcel_finder,a=t.dhl_parcel_locator,p=e.getModal(),r=a.getShippingMethod(),n=a.getShippingMethodData(r);n&&(p.find(".finder-pickup-type").addClass("hidden"),o.each(n.supports,function(e,a){var r=p.find('.finder-pickup-type[data-pickup_type="'+a+'"]');r.find("input[type=checkbox]").prop("checked",!0),r.removeClass("hidden")}))},openModal:function(){var e=t.dhl_parcel_finder,a=e.getModal(),r=0<o(e.wrapper+" #shipping_country").val().length?o(e.wrapper+" #shipping_country").val():o(e.wrapper+" #billing_country").val();a.find("#dhl-parcelfinder-country").val(r);var p=0<o(e.wrapper+" #shipping_postcode").val().length?o(e.wrapper+" #shipping_postcode").val():o(e.wrapper+" #billing_postcode").val();a.find("#dhl-parcelfinder-postcode").val(p);var n=0<o(e.wrapper+" #shipping_city").val().length?o(e.wrapper+" #shipping_city").val():o(e.wrapper+" #billing_city").val();return a.find("#dhl-parcelfinder-city").val(n),a.addClass("open"),a.find("#dhl-parcel-finder-form").submit(),!1},closeModal:function(){return t.dhl_parcel_finder.getModal().removeClass("open"),!1},getModal:function(){return o("#dhl-parcel-finder-wrapper")},doAjax:function(e,r,a,p){var n=t.dhl_parcel_finder;a=a||n.onAjaxSuccess,p=p||n.onAjaxError,e.hasOwnProperty("security")||(e.security=n.params.parcel_finder_nonce),r.find("#dhl-parcel-finder-map").block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),r.find(".notice-wrapper").empty(),o.ajax({type:"POST",url:n.params.ajax_url,data:e,success:function(e){e.success?(r.find("#dhl-parcel-finder-map").unblock(),a.apply(r,[e])):(p.apply(r,[e]),r.find("#dhl-parcel-finder-map").unblock(),e.hasOwnProperty("message")?n.addNotice(e.message,"error",r):e.hasOwnProperty("messages")&&o.each(e.messages,function(e,a){n.addNotice(a,"error",r)}))},error:function(e){},dataType:"json"})},onAjaxSuccess:function(e){},onAjaxError:function(e){},getFormData:function(e){var r={};return o.each(e.serializeArray(),function(e,a){-1!==a.name.indexOf("[]")?(a.name=a.name.replace("[]",""),r[a.name]=o.makeArray(r[a.name]),r[a.name].push(a.value)):r[a.name]=a.value}),r},onSubmit:function(e){var a=t.dhl_parcel_finder,r=t.dhl_parcel_locator,p=a.getModal().find("#dhl-parcel-finder"),n=p.find("form"),i=a.getFormData(n);return i.action="woocommerce_gzd_dhl_parcelfinder_search",i.is_checkout=r.isCheckout()?"yes":"no",a.doAjax(i,p,a.onSubmitSuccess),!1},onSubmitSuccess:function(e){var a=t.dhl_parcel_finder;e.parcel_shops&&(a.parcelShops=e.parcel_shops,"object"==typeof google&&"object"==typeof google.maps?a.updateMap():a.loadMapsAPI())},loadMapsAPI:function(){var e=t.dhl_parcel_finder;e.addScript("https://maps.googleapis.com/maps/api/js?key="+e.params.api_key,e.updateMap)},addScript:function(e,a){var r=document.createElement("script");a&&(r.onload=a),r.type="text/javascript",r.src=e,document.body.appendChild(r)},updateMap:function(){var l=t.dhl_parcel_finder,e=l.parcelShops,a={lat:e[0].location.latitude,lng:e[0].location.longitude},c=new google.maps.Map(document.getElementById("dhl-parcel-finder-map"),{zoom:13,center:a}),d=[];o.each(e,function(e,a){var r={lat:a.location.latitude,lng:a.location.longitude},p=l.params.packstation_icon,n=l.params.i18n.packstation;switch(a.gzd_type){case"parcelshop":p=l.params.parcelshop_icon,n=l.params.i18n.branch;break;case"postoffice":p=l.params.postoffice_icon,n=l.params.i18n.branch}var i=new google.maps.InfoWindow({content:a.html_content,maxWidth:300});d.push(i);var o=new google.maps.Marker({position:r,map:c,title:n,animation:google.maps.Animation.DROP,icon:p});o.addListener("click",function(){!function a(){for(var e=0;e<d.length;e++)d[e].close()}(),i.open(c,o)})})},onSelectShop:function(){var p=t.dhl_parcel_finder,n=parseInt(o(this).attr("id")),i=o(p.wrapper+" #shipping_address_type");o.each(p.parcelShops,function(e,a){if(parseInt(a.id)===n){var r="packstation"===a.gzd_type;return o(p.wrapper+" #shipping_first_name").val(0<o(p.wrapper+" #shipping_first_name").val().length?o(p.wrapper+" #shipping_first_name").val():o(p.wrapper+" #billing_first_name").val()),o(p.wrapper+" #shipping_last_name").val(0<o(p.wrapper+" #shipping_last_name").val().length?o(p.wrapper+" #shipping_last_name").val():o(p.wrapper+" #billing_last_name").val()),o(p.wrapper+" #shipping_address_1").val(a.gzd_name),o(p.wrapper+" #shipping_address_2").val(""),o(p.wrapper+" #shipping_postcode").val(a.address.zip),o(p.wrapper+" #shipping_city").val(a.address.city),i.val("dhl").trigger("change"),p.closeModal(),r&&""===o(p.wrapper+" #shipping_dhl_postnumber").val()&&o(p.wrapper+" #shipping_dhl_postnumber").focus(),!0}})},addNotice:function(e,a,r){r.find(".notice-wrapper").append('<div class="notice notice-'+a+'"><p>'+e+"</p></div>")}},o(document).ready(function(){t.dhl_parcel_finder.init()})}(jQuery,window.germanized);